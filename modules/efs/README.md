# AWS Elastic File System (EFS) Module

This module is used to:

1. Create an encrypted EFS file system
2. Create mount targets in subnets for client access
3. Create a default EFS mount target security group allowing NFS traffic to/from that group

## Known Issues

Occasional timeouts when creating terraform resources are expected depending on the speed of the AWS API that day, simply, re-run the `terraform apply` command.

## How NFS Clients Access the EFS Mount Targets

Module output includes the default security group of the EFS Target Mounts: `module.efs.efs_security_group_id`

Default rules: `tcp` `2049` `ingres` & `egress` to/from `self`

To allow NFS traffic between EFS mount targets and clients there are two options:

1. Grant clients access by attaching the security group output by this module to them `module.efs.efs_security_group_id`.
   1. This will allow `tcp` `2049` `to`/`from` all resources this group is attached to.
   2. Use the method below ([How to Add Additional Security Group Rules](#how-to-add-additional-security-group-rules)) to add custom rules to the default security group.

### How to Add Additional Security Group Rules

To add additional security group rules to the EFS Mount Target Security Group in the EFS File System, you can use the
[aws_security_group_rule](https://www.terraform.io/docs/providers/aws/r/security_group_rule.html) resource, and set its
`security_group_id` argument to the Terraform output of this module called `efs_security_group_id`. For
example, here is how you can allow NFS traffic (tcp 2049) ingress to the EFS Mount Targets from another security
group defined outside this module.

```hcl
# This EFS Module
module "efs" {
  # (arguments omitted)
}

#Grant NFS ingress to EFS from another security group source
resource "aws_security_group_rule" "allow_nfs_from_other_sg" {
  type      = "ingress"
  from_port = 2049
  to_port   = 2049
  protocol  = "tcp"
  source_security_group_id = "${var.some_other_security_group_id}"

  security_group_id = "${module.ecs_cluster.efs_security_group_id}"
}

#Grant NFS ingress access from a CIDR block
resource "aws_security_group_rule" "allow_nfs_from_other_sg" {
  type        = "ingress"
  from_port   = 2049
  to_port     = 2049
  protocol    = "tcp"
  cidr_blocks = ["10.11.12.13/14"]

  security_group_id = "${module.ecs_cluster.efs_security_group_id}"
}


```

## Inputs

| Name                               | Description                                                                                                                                                                 |  Type  |      Default       | Required |
| ---------------------------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | :----: | :----------------: | :------: |
| creation\_token                    | (Optional) A unique name (max of 64 characters) used as reference to ensure idempotent file system creation. By default generated by Terraform.                             | string |        `""`        |    no    |
| kms\_key\_id                       | The ARN for the KMS encryption key. Not Optional.                                                                                                                           | string |        n/a         |   yes    |
| name                               | The name tag of the file system. Also used in the name of the security group. Different than creation_token                                                                 | string |        n/a         |   yes    |
| performance\_mode                  | (Optional) The file system performance mode. Can be either 'generalPurpose' or 'maxIO' (Default: 'generalPurpose').                                                         | string | `"generalPurpose"` |    no    |
| provisioned\_throughput\_in\_mibps | (Optional) The throughput, measured in MiB/s, that you provision for the file system. Only applicable with throughput_mode set to provisioned.                              | string |       `"0"`        |    no    |
| subnet\_ids                        | A list of subnet ids where efs file mount network interfaces will be created. Must be in same VPC.                                                                          |  list  |        n/a         |   yes    |
| tags                               | (Optional) A map of tags applied to all resources.                                                                                                                          |  map   |      `<map>`       |    no    |
| throughput\_mode                   | (Optional) Throughput mode for the file system. Defaults to bursting. Valid values: bursting, provisioned. When using provisioned, also set provisioned_throughput_in_mibps | string |    `"bursting"`    |    no    |
| vpc\_id                            | The AWS VPC id of the default EFS mount security group.                                                                                                                     | string |        n/a         |   yes    |

## Outputs

| Name                                   | Description                                                              |
| -------------------------------------- | ------------------------------------------------------------------------ |
| efs\_arn                               | Amazon Resource Name of the file system.                                 |
| efs\_dns\_name                         | The DNS name for the filesystem per documented convention.               |
| efs\_id                                | The ID that identifies the file system (e.g. fs-ccfc0d65).               |
| efs\_security\_group\_id               | The default security group of the efs mount target network interface ids |
| mount\_target\_dns                     | Address of the mount target provisioned.                                 |
| mount\_target\_ids                     | List of mount target AWS resource IDs                                    |
| mount\_target\_network\_interface\_ids | List of mount target network interface ids.                              |
